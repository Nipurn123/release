
<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for Users/nipurnagarwal/Desktop/100XPrompt_agent/code-server/lib/vscode/extensions/cline/src/api/transform/openrouter-stream.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../../../../../../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../../../../../../../../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../../../../../../../../../../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../../../../../../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../../../../../../../../../../../index.html">All files</a> / <a href="index.html">Users/nipurnagarwal/Desktop/100XPrompt_agent/code-server/lib/vscode/extensions/cline/src/api/transform</a> openrouter-stream.ts</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">3.77% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>6/159</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">100% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>0/0</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>0/1</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">3.77% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>6/159</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line low'></div>
    <pre><table class="coverage">
<tr><td class="line-count quiet"><a name='L1'></a><a href='#L1'>1</a>
<a name='L2'></a><a href='#L2'>2</a>
<a name='L3'></a><a href='#L3'>3</a>
<a name='L4'></a><a href='#L4'>4</a>
<a name='L5'></a><a href='#L5'>5</a>
<a name='L6'></a><a href='#L6'>6</a>
<a name='L7'></a><a href='#L7'>7</a>
<a name='L8'></a><a href='#L8'>8</a>
<a name='L9'></a><a href='#L9'>9</a>
<a name='L10'></a><a href='#L10'>10</a>
<a name='L11'></a><a href='#L11'>11</a>
<a name='L12'></a><a href='#L12'>12</a>
<a name='L13'></a><a href='#L13'>13</a>
<a name='L14'></a><a href='#L14'>14</a>
<a name='L15'></a><a href='#L15'>15</a>
<a name='L16'></a><a href='#L16'>16</a>
<a name='L17'></a><a href='#L17'>17</a>
<a name='L18'></a><a href='#L18'>18</a>
<a name='L19'></a><a href='#L19'>19</a>
<a name='L20'></a><a href='#L20'>20</a>
<a name='L21'></a><a href='#L21'>21</a>
<a name='L22'></a><a href='#L22'>22</a>
<a name='L23'></a><a href='#L23'>23</a>
<a name='L24'></a><a href='#L24'>24</a>
<a name='L25'></a><a href='#L25'>25</a>
<a name='L26'></a><a href='#L26'>26</a>
<a name='L27'></a><a href='#L27'>27</a>
<a name='L28'></a><a href='#L28'>28</a>
<a name='L29'></a><a href='#L29'>29</a>
<a name='L30'></a><a href='#L30'>30</a>
<a name='L31'></a><a href='#L31'>31</a>
<a name='L32'></a><a href='#L32'>32</a>
<a name='L33'></a><a href='#L33'>33</a>
<a name='L34'></a><a href='#L34'>34</a>
<a name='L35'></a><a href='#L35'>35</a>
<a name='L36'></a><a href='#L36'>36</a>
<a name='L37'></a><a href='#L37'>37</a>
<a name='L38'></a><a href='#L38'>38</a>
<a name='L39'></a><a href='#L39'>39</a>
<a name='L40'></a><a href='#L40'>40</a>
<a name='L41'></a><a href='#L41'>41</a>
<a name='L42'></a><a href='#L42'>42</a>
<a name='L43'></a><a href='#L43'>43</a>
<a name='L44'></a><a href='#L44'>44</a>
<a name='L45'></a><a href='#L45'>45</a>
<a name='L46'></a><a href='#L46'>46</a>
<a name='L47'></a><a href='#L47'>47</a>
<a name='L48'></a><a href='#L48'>48</a>
<a name='L49'></a><a href='#L49'>49</a>
<a name='L50'></a><a href='#L50'>50</a>
<a name='L51'></a><a href='#L51'>51</a>
<a name='L52'></a><a href='#L52'>52</a>
<a name='L53'></a><a href='#L53'>53</a>
<a name='L54'></a><a href='#L54'>54</a>
<a name='L55'></a><a href='#L55'>55</a>
<a name='L56'></a><a href='#L56'>56</a>
<a name='L57'></a><a href='#L57'>57</a>
<a name='L58'></a><a href='#L58'>58</a>
<a name='L59'></a><a href='#L59'>59</a>
<a name='L60'></a><a href='#L60'>60</a>
<a name='L61'></a><a href='#L61'>61</a>
<a name='L62'></a><a href='#L62'>62</a>
<a name='L63'></a><a href='#L63'>63</a>
<a name='L64'></a><a href='#L64'>64</a>
<a name='L65'></a><a href='#L65'>65</a>
<a name='L66'></a><a href='#L66'>66</a>
<a name='L67'></a><a href='#L67'>67</a>
<a name='L68'></a><a href='#L68'>68</a>
<a name='L69'></a><a href='#L69'>69</a>
<a name='L70'></a><a href='#L70'>70</a>
<a name='L71'></a><a href='#L71'>71</a>
<a name='L72'></a><a href='#L72'>72</a>
<a name='L73'></a><a href='#L73'>73</a>
<a name='L74'></a><a href='#L74'>74</a>
<a name='L75'></a><a href='#L75'>75</a>
<a name='L76'></a><a href='#L76'>76</a>
<a name='L77'></a><a href='#L77'>77</a>
<a name='L78'></a><a href='#L78'>78</a>
<a name='L79'></a><a href='#L79'>79</a>
<a name='L80'></a><a href='#L80'>80</a>
<a name='L81'></a><a href='#L81'>81</a>
<a name='L82'></a><a href='#L82'>82</a>
<a name='L83'></a><a href='#L83'>83</a>
<a name='L84'></a><a href='#L84'>84</a>
<a name='L85'></a><a href='#L85'>85</a>
<a name='L86'></a><a href='#L86'>86</a>
<a name='L87'></a><a href='#L87'>87</a>
<a name='L88'></a><a href='#L88'>88</a>
<a name='L89'></a><a href='#L89'>89</a>
<a name='L90'></a><a href='#L90'>90</a>
<a name='L91'></a><a href='#L91'>91</a>
<a name='L92'></a><a href='#L92'>92</a>
<a name='L93'></a><a href='#L93'>93</a>
<a name='L94'></a><a href='#L94'>94</a>
<a name='L95'></a><a href='#L95'>95</a>
<a name='L96'></a><a href='#L96'>96</a>
<a name='L97'></a><a href='#L97'>97</a>
<a name='L98'></a><a href='#L98'>98</a>
<a name='L99'></a><a href='#L99'>99</a>
<a name='L100'></a><a href='#L100'>100</a>
<a name='L101'></a><a href='#L101'>101</a>
<a name='L102'></a><a href='#L102'>102</a>
<a name='L103'></a><a href='#L103'>103</a>
<a name='L104'></a><a href='#L104'>104</a>
<a name='L105'></a><a href='#L105'>105</a>
<a name='L106'></a><a href='#L106'>106</a>
<a name='L107'></a><a href='#L107'>107</a>
<a name='L108'></a><a href='#L108'>108</a>
<a name='L109'></a><a href='#L109'>109</a>
<a name='L110'></a><a href='#L110'>110</a>
<a name='L111'></a><a href='#L111'>111</a>
<a name='L112'></a><a href='#L112'>112</a>
<a name='L113'></a><a href='#L113'>113</a>
<a name='L114'></a><a href='#L114'>114</a>
<a name='L115'></a><a href='#L115'>115</a>
<a name='L116'></a><a href='#L116'>116</a>
<a name='L117'></a><a href='#L117'>117</a>
<a name='L118'></a><a href='#L118'>118</a>
<a name='L119'></a><a href='#L119'>119</a>
<a name='L120'></a><a href='#L120'>120</a>
<a name='L121'></a><a href='#L121'>121</a>
<a name='L122'></a><a href='#L122'>122</a>
<a name='L123'></a><a href='#L123'>123</a>
<a name='L124'></a><a href='#L124'>124</a>
<a name='L125'></a><a href='#L125'>125</a>
<a name='L126'></a><a href='#L126'>126</a>
<a name='L127'></a><a href='#L127'>127</a>
<a name='L128'></a><a href='#L128'>128</a>
<a name='L129'></a><a href='#L129'>129</a>
<a name='L130'></a><a href='#L130'>130</a>
<a name='L131'></a><a href='#L131'>131</a>
<a name='L132'></a><a href='#L132'>132</a>
<a name='L133'></a><a href='#L133'>133</a>
<a name='L134'></a><a href='#L134'>134</a>
<a name='L135'></a><a href='#L135'>135</a>
<a name='L136'></a><a href='#L136'>136</a>
<a name='L137'></a><a href='#L137'>137</a>
<a name='L138'></a><a href='#L138'>138</a>
<a name='L139'></a><a href='#L139'>139</a>
<a name='L140'></a><a href='#L140'>140</a>
<a name='L141'></a><a href='#L141'>141</a>
<a name='L142'></a><a href='#L142'>142</a>
<a name='L143'></a><a href='#L143'>143</a>
<a name='L144'></a><a href='#L144'>144</a>
<a name='L145'></a><a href='#L145'>145</a>
<a name='L146'></a><a href='#L146'>146</a>
<a name='L147'></a><a href='#L147'>147</a>
<a name='L148'></a><a href='#L148'>148</a>
<a name='L149'></a><a href='#L149'>149</a>
<a name='L150'></a><a href='#L150'>150</a>
<a name='L151'></a><a href='#L151'>151</a>
<a name='L152'></a><a href='#L152'>152</a>
<a name='L153'></a><a href='#L153'>153</a>
<a name='L154'></a><a href='#L154'>154</a>
<a name='L155'></a><a href='#L155'>155</a>
<a name='L156'></a><a href='#L156'>156</a>
<a name='L157'></a><a href='#L157'>157</a>
<a name='L158'></a><a href='#L158'>158</a>
<a name='L159'></a><a href='#L159'>159</a>
<a name='L160'></a><a href='#L160'>160</a></td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { ModelInfo } from "@shared/api"
import { convertToOpenAiMessages } from "@api/transform/openai-format"
import { convertToR1Format } from "@api/transform/r1-format"
import { Anthropic } from "@anthropic-ai/sdk"
import OpenAI from "openai"
&nbsp;
<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >export async function createOpenRouterStream(</span></span>
<span class="cstat-no" title="statement not covered" >	client: OpenAI,</span>
<span class="cstat-no" title="statement not covered" >	systemPrompt: string,</span>
<span class="cstat-no" title="statement not covered" >	messages: Anthropic.Messages.MessageParam[],</span>
<span class="cstat-no" title="statement not covered" >	model: { id: string; info: ModelInfo },</span>
<span class="cstat-no" title="statement not covered" >	reasoningEffort?: string,</span>
<span class="cstat-no" title="statement not covered" >	thinkingBudgetTokens?: number,</span>
<span class="cstat-no" title="statement not covered" >	openRouterProviderSorting?: string,</span>
<span class="cstat-no" title="statement not covered" >) {</span>
<span class="cstat-no" title="statement not covered" >	// Convert Anthropic messages to OpenAI format</span>
<span class="cstat-no" title="statement not covered" >	let openAiMessages: OpenAI.Chat.ChatCompletionMessageParam[] = [</span>
<span class="cstat-no" title="statement not covered" >		{ role: "system", content: systemPrompt },</span>
<span class="cstat-no" title="statement not covered" >		...convertToOpenAiMessages(messages),</span>
<span class="cstat-no" title="statement not covered" >	]</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >	// prompt caching: https://openrouter.ai/docs/prompt-caching</span>
<span class="cstat-no" title="statement not covered" >	// this was initially specifically for claude models (some models may 'support prompt caching' automatically without this)</span>
<span class="cstat-no" title="statement not covered" >	// handles direct model.id match logic</span>
<span class="cstat-no" title="statement not covered" >	switch (model.id) {</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-sonnet-4":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-opus-4":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet:thinking":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-7-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-7-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet-20240620":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet-20240620:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku-20241022":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku-20241022:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-haiku":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-haiku:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-opus":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-opus:beta":</span>
<span class="cstat-no" title="statement not covered" >			openAiMessages[0] = {</span>
<span class="cstat-no" title="statement not covered" >				role: "system",</span>
<span class="cstat-no" title="statement not covered" >				content: [</span>
<span class="cstat-no" title="statement not covered" >					{</span>
<span class="cstat-no" title="statement not covered" >						type: "text",</span>
<span class="cstat-no" title="statement not covered" >						text: systemPrompt,</span>
<span class="cstat-no" title="statement not covered" >						// @ts-ignore-next-line</span>
<span class="cstat-no" title="statement not covered" >						cache_control: { type: "ephemeral" },</span>
<span class="cstat-no" title="statement not covered" >					},</span>
<span class="cstat-no" title="statement not covered" >				],</span>
<span class="cstat-no" title="statement not covered" >			}</span>
<span class="cstat-no" title="statement not covered" >			// Add cache_control to the last two user messages</span>
<span class="cstat-no" title="statement not covered" >			// (note: this works because we only ever add one user message at a time, but if we added multiple we'd need to mark the user message before the last assistant message)</span>
<span class="cstat-no" title="statement not covered" >			const lastTwoUserMessages = openAiMessages.filter((msg) =&gt; msg.role === "user").slice(-2)</span>
<span class="cstat-no" title="statement not covered" >			lastTwoUserMessages.forEach((msg) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >				if (typeof msg.content === "string") {</span>
<span class="cstat-no" title="statement not covered" >					msg.content = [{ type: "text", text: msg.content }]</span>
<span class="cstat-no" title="statement not covered" >				}</span>
<span class="cstat-no" title="statement not covered" >				if (Array.isArray(msg.content)) {</span>
<span class="cstat-no" title="statement not covered" >					// NOTE: this is fine since env details will always be added at the end. but if it weren't there, and the user added a image_url type message, it would pop a text part before it and then move it after to the end.</span>
<span class="cstat-no" title="statement not covered" >					let lastTextPart = msg.content.filter((part) =&gt; part.type === "text").pop()</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >					if (!lastTextPart) {</span>
<span class="cstat-no" title="statement not covered" >						lastTextPart = { type: "text", text: "..." }</span>
<span class="cstat-no" title="statement not covered" >						msg.content.push(lastTextPart)</span>
<span class="cstat-no" title="statement not covered" >					}</span>
<span class="cstat-no" title="statement not covered" >					// @ts-ignore-next-line</span>
<span class="cstat-no" title="statement not covered" >					lastTextPart["cache_control"] = { type: "ephemeral" }</span>
<span class="cstat-no" title="statement not covered" >				}</span>
<span class="cstat-no" title="statement not covered" >			})</span>
<span class="cstat-no" title="statement not covered" >			break</span>
<span class="cstat-no" title="statement not covered" >		default:</span>
<span class="cstat-no" title="statement not covered" >			break</span>
<span class="cstat-no" title="statement not covered" >	}</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >	// Not sure how openrouter defaults max tokens when no value is provided, but the anthropic api requires this value and since they offer both 4096 and 8192 variants, we should ensure 8192.</span>
<span class="cstat-no" title="statement not covered" >	// (models usually default to max tokens allowed)</span>
<span class="cstat-no" title="statement not covered" >	let maxTokens: number | undefined</span>
<span class="cstat-no" title="statement not covered" >	switch (model.id) {</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-sonnet-4":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-opus-4":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet:thinking":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-7-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-7-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet-20240620":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.5-sonnet-20240620:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku-20241022":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-5-haiku-20241022:beta":</span>
<span class="cstat-no" title="statement not covered" >			maxTokens = 8_192</span>
<span class="cstat-no" title="statement not covered" >			break</span>
<span class="cstat-no" title="statement not covered" >	}</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >	let temperature: number | undefined = 0</span>
<span class="cstat-no" title="statement not covered" >	let topP: number | undefined = undefined</span>
<span class="cstat-no" title="statement not covered" >	if (</span>
<span class="cstat-no" title="statement not covered" >		model.id.startsWith("deepseek/deepseek-r1") ||</span>
<span class="cstat-no" title="statement not covered" >		model.id === "perplexity/sonar-reasoning" ||</span>
<span class="cstat-no" title="statement not covered" >		model.id === "qwen/qwq-32b:free" ||</span>
<span class="cstat-no" title="statement not covered" >		model.id === "qwen/qwq-32b"</span>
<span class="cstat-no" title="statement not covered" >	) {</span>
<span class="cstat-no" title="statement not covered" >		// Recommended values from DeepSeek</span>
<span class="cstat-no" title="statement not covered" >		temperature = 0.7</span>
<span class="cstat-no" title="statement not covered" >		topP = 0.95</span>
<span class="cstat-no" title="statement not covered" >		openAiMessages = convertToR1Format([{ role: "user", content: systemPrompt }, ...messages])</span>
<span class="cstat-no" title="statement not covered" >	}</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >	let reasoning: { max_tokens: number } | undefined = undefined</span>
<span class="cstat-no" title="statement not covered" >	switch (model.id) {</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-sonnet-4":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-opus-4":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3.7-sonnet:thinking":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-7-sonnet":</span>
<span class="cstat-no" title="statement not covered" >		case "anthropic/claude-3-7-sonnet:beta":</span>
<span class="cstat-no" title="statement not covered" >			let budget_tokens = thinkingBudgetTokens || 0</span>
<span class="cstat-no" title="statement not covered" >			const reasoningOn = budget_tokens !== 0 ? true : false</span>
<span class="cstat-no" title="statement not covered" >			if (reasoningOn) {</span>
<span class="cstat-no" title="statement not covered" >				temperature = undefined // extended thinking does not support non-1 temperature</span>
<span class="cstat-no" title="statement not covered" >				reasoning = { max_tokens: budget_tokens }</span>
<span class="cstat-no" title="statement not covered" >			}</span>
<span class="cstat-no" title="statement not covered" >			break</span>
<span class="cstat-no" title="statement not covered" >	}</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >	// Removes messages in the middle when close to context window limit. Should not be applied to models that support prompt caching since it would continuously break the cache.</span>
<span class="cstat-no" title="statement not covered" >	let shouldApplyMiddleOutTransform = !model.info.supportsPromptCache</span>
<span class="cstat-no" title="statement not covered" >	// except for deepseek (which we set supportsPromptCache to true for), where because the context window is so small our truncation algo might miss and we should use openrouter's middle-out transform as a fallback to ensure we don't exceed the context window (FIXME: once we have a more robust token estimator we should not rely on this)</span>
<span class="cstat-no" title="statement not covered" >	if (model.id === "deepseek/deepseek-chat") {</span>
<span class="cstat-no" title="statement not covered" >		shouldApplyMiddleOutTransform = true</span>
<span class="cstat-no" title="statement not covered" >	}</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >	// @ts-ignore-next-line</span>
<span class="cstat-no" title="statement not covered" >	const stream = await client.chat.completions.create({</span>
<span class="cstat-no" title="statement not covered" >		model: model.id,</span>
<span class="cstat-no" title="statement not covered" >		max_tokens: maxTokens,</span>
<span class="cstat-no" title="statement not covered" >		temperature: temperature,</span>
<span class="cstat-no" title="statement not covered" >		top_p: topP,</span>
<span class="cstat-no" title="statement not covered" >		messages: openAiMessages,</span>
<span class="cstat-no" title="statement not covered" >		stream: true,</span>
<span class="cstat-no" title="statement not covered" >		stream_options: { include_usage: true },</span>
<span class="cstat-no" title="statement not covered" >		transforms: shouldApplyMiddleOutTransform ? ["middle-out"] : undefined,</span>
<span class="cstat-no" title="statement not covered" >		include_reasoning: true,</span>
<span class="cstat-no" title="statement not covered" >		...(model.id.startsWith("openai/o") ? { reasoning_effort: reasoningEffort || "medium" } : {}),</span>
<span class="cstat-no" title="statement not covered" >		...(reasoning ? { reasoning } : {}),</span>
<span class="cstat-no" title="statement not covered" >		...(openRouterProviderSorting ? { provider: { sort: openRouterProviderSorting } } : {}),</span>
<span class="cstat-no" title="statement not covered" >	})</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >	return stream</span>
<span class="cstat-no" title="statement not covered" >}</span>
&nbsp;</pre></td></tr></table></pre>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-06-11T15:11:48.959Z
            </div>
        <script src="../../../../../../../../../../../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../../../../../../../../../../../sorter.js"></script>
        <script src="../../../../../../../../../../../../block-navigation.js"></script>
    </body>
</html>
    